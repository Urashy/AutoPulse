@using BlazorAutoPulse.ViewModel
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="search-bar">
    <!-- Champ de recherche par nom -->
    <div class="search-input-group">
        <input type="text"
               @bind="VM.Nom"
               @bind:event="oninput"
               placeholder="üîç Rechercher par nom de v√©hicule..."
               class="search-input-main">
    </div>

    <!-- Filtres en listes d√©roulantes -->
    <div class="filters-row">
        <!-- Marque -->
        <div class="filter-group">
            <label>Marque</label>
            <select value="@VM.SelectedMarque" @onchange="VM.OnMarqueChanged">
                <option value="0">Toutes les marques</option>
                @if (VM.AllMarques != null)
                {
                    @foreach (var marque in VM.AllMarques)
                    {
                        <option value="@marque.IdMarque">@marque.LibelleMarque</option>
                    }
                }
            </select>
        </div>

        <!-- Mod√®le -->
        <div class="filter-group">
            <label>Mod√®le</label>
            <select value="@VM.SelectedModele" @onchange="e => { VM.SelectedModele = e.Value?.ToString() ?? string.Empty; }">
                <option value="">Tous les mod√®les</option>
                @if (VM.FilteredModeles != null)
                {
                    @foreach (var modele in VM.FilteredModeles)
                    {
                        <option value="@modele.IdModele">@modele.LibelleModele</option>
                    }
                }
            </select>
        </div>

        <!-- Carburant -->
        <div class="filter-group">
            <label>Carburant</label>
            <select value="@VM.SelectedCarburant" @onchange="e => { VM.SelectedCarburant = e.Value?.ToString() ?? string.Empty; }">
                <option value="0">Tous les carburants</option>
                @if (VM.AllCarburants != null)
                {
                    @foreach (var carburant in VM.AllCarburants)
                    {
                        <option value="@carburant.IdCarburant">@carburant.LibelleCarburant</option>
                    }
                }
            </select>
        </div>

        <!-- Cat√©gorie -->
        <div class="filter-group">
            <label>Cat√©gorie</label>
            <select value="@VM.SelectedCategorie" @onchange="e => { VM.SelectedCategorie = e.Value?.ToString() ?? string.Empty; }">
                <option value="0">Toutes les cat√©gories</option>
                @if (VM.AllCategories != null)
                {
                    @foreach (var categorie in VM.AllCategories)
                    {
                        <option value="@categorie.IdCategorie">@categorie.LibelleCategorie</option>
                    }
                }
            </select>
        </div>

        <!-- D√©partement -->
        <div class="filter-group">
            <label>D√©partement</label>
            <input type="text" @bind="VM.Departement" placeholder="Ex: 73">
        </div>
    </div>

    <!-- Sliders pour Prix et Kilom√©trage -->
    <div class="sliders-container">
        <!-- Dual Slider Prix -->
        <div class="slider-group">
            <label>Prix</label>
            <div class="slider-info">
                <span id="prix-min-display">@FormatPrixMin(VM.PrixMinValue) ‚Ç¨</span>
                <span id="prix-max-display">@FormatPrixMax(VM.PrixMaxValue)</span>
            </div>
            <div class="dual-range-slider">
                <div class="slider-track"></div>
                <div class="slider-range" id="prix-range" style="@GetRangeStyle(VM.PrixMinValue, VM.PrixMaxValue, 0, 200000)"></div>
                <input type="range"
                       id="prix-slider-min"
                       min="0"
                       max="200000"
                       step="1000"
                       value="@VM.PrixMinValue"
                       class="range-input range-min">
                <input type="range"
                       id="prix-slider-max"
                       min="0"
                       max="200000"
                       step="1000"
                       value="@VM.PrixMaxValue"
                       class="range-input range-max">
            </div>
        </div>

        <!-- Dual Slider Kilom√©trage -->
        <div class="slider-group">
            <label>Kilom√©trage</label>
            <div class="slider-info">
                <span id="km-min-display">@FormatKmMin(VM.KmMinValue) km</span>
                <span id="km-max-display">@FormatKmMax(VM.KmMaxValue)</span>
            </div>
            <div class="dual-range-slider">
                <div class="slider-track"></div>
                <div class="slider-range" id="km-range" style="@GetRangeStyle(VM.KmMinValue, VM.KmMaxValue, 0, 300000)"></div>
                <input type="range"
                       id="km-slider-min"
                       min="0"
                       max="300000"
                       step="5000"
                       value="@VM.KmMinValue"
                       class="range-input range-min">
                <input type="range"
                       id="km-slider-max"
                       min="0"
                       max="300000"
                       step="5000"
                       value="@VM.KmMaxValue"
                       class="range-input range-max">
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button @onclick="HandleRecherche" class="btn-primary">üîç Rechercher</button>
        <button @onclick="HandleReset" class="btn-secondary">üîÑ R√©initialiser</button>
    </div>
</div>

@if (VM.HasActiveFilters())
{
    <div class="active-filters">
        <span>Filtres actifs :</span>
        @if (VM.SelectedMarque != "0")
        {
            <span class="filter-tag">Marque: @VM.GetMarqueLibelle(VM.SelectedMarque)</span>
        }
        @if (!string.IsNullOrEmpty(VM.SelectedModele))
        {
            <span class="filter-tag">Mod√®le: @VM.GetModeleLibelle(VM.SelectedModele)</span>
        }
        @if (VM.SelectedCarburant != "0")
        {
            <span class="filter-tag">Carburant: @VM.GetCarburantLibelle(VM.SelectedCarburant)</span>
        }
        @if (VM.SelectedCategorie != "0")
        {
            <span class="filter-tag">Cat√©gorie: @VM.GetCategorieLibelle(VM.SelectedCategorie)</span>
        }
        @if (VM.PrixMinValue > 0 || VM.PrixMaxValue < 200000)
        {
            <span class="filter-tag">Prix: @FormatPrice(VM.PrixMinValue) - @FormatPrice(VM.PrixMaxValue) ‚Ç¨</span>
        }
        @if (VM.KmMinValue > 0 || VM.KmMaxValue < 300000)
        {
            <span class="filter-tag">Km: @FormatKm(VM.KmMinValue) - @FormatKm(VM.KmMaxValue)</span>
        }
        @if (!string.IsNullOrEmpty(VM.Nom))
        {
            <span class="filter-tag">Nom: @VM.Nom</span>
        }
        @if (!string.IsNullOrEmpty(VM.Departement))
        {
            <span class="filter-tag">D√©partement: @VM.Departement</span>
        }
    </div>
}

@code {
    [Parameter]
    public required RechercheViewModel VM { get; set; }

    [Parameter]
    public bool IsHomePage { get; set; } = false;

    private const int MinGapPrix = 5000;
    private const int MinGapKm = 10000;

    private DotNetObjectReference<BarreDeRechercheAvecFiltresComposant>? objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("initDualSliders", objRef, MinGapPrix, MinGapKm);
        }
    }

    [JSInvokable]
    public void UpdatePrixMin(int value)
    {
        VM.PrixMinValue = value;
        StateHasChanged();
    }

    [JSInvokable]
    public void UpdatePrixMax(int value)
    {
        VM.PrixMaxValue = value;
        StateHasChanged();
    }

    [JSInvokable]
    public void UpdateKmMin(int value)
    {
        VM.KmMinValue = value;
        StateHasChanged();
    }

    [JSInvokable]
    public void UpdateKmMax(int value)
    {
        VM.KmMaxValue = value;
        StateHasChanged();
    }

    private string GetRangeStyle(int minValue, int maxValue, int rangeMin, int rangeMax)
    {
        double range = rangeMax - rangeMin;
        double left = ((minValue - rangeMin) / range) * 100;
        double right = 100 - ((maxValue - rangeMin) / range) * 100;
        return $"left: {left.ToString(System.Globalization.CultureInfo.InvariantCulture)}%; right: {right.ToString(System.Globalization.CultureInfo.InvariantCulture)}%;";
    }

    private async Task HandleRecherche()
    {
        if (IsHomePage)
        {
            var queryString = VM.BuildQueryString();
            Navigation.NavigateTo($"/search{queryString}");
        }
        else
        {
            await VM.EffectuerRecherche();
        }
    }

    private async Task HandleReset()
    {
        VM.ReinitialiserFiltres();
        await JSRuntime.InvokeVoidAsync("resetSliders", VM.PrixMinValue, VM.PrixMaxValue, VM.KmMinValue, VM.KmMaxValue);
        if (!IsHomePage)
        {
            await VM.EffectuerRecherche();
        }
    }

    private string FormatPrice(int price)
    {
        return price.ToString("N0", System.Globalization.CultureInfo.GetCultureInfo("fr-FR"));
    }

    private string FormatKm(int km)
    {
        return km.ToString("N0", System.Globalization.CultureInfo.GetCultureInfo("fr-FR"));
    }

    private string FormatPrixMin(int price)
    {
        return price.ToString("N0", System.Globalization.CultureInfo.GetCultureInfo("fr-FR"));
    }

    private string FormatPrixMax(int price)
    {
        if (price >= 200000)
            return "Illimit√©";
        return price.ToString("N0", System.Globalization.CultureInfo.GetCultureInfo("fr-FR")) + " ‚Ç¨";
    }

    private string FormatKmMin(int km)
    {
        return km.ToString("N0", System.Globalization.CultureInfo.GetCultureInfo("fr-FR"));
    }

    private string FormatKmMax(int km)
    {
        if (km >= 300000)
            return "Illimit√©";
        return km.ToString("N0", System.Globalization.CultureInfo.GetCultureInfo("fr-FR")) + " km";
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }
}

<script>
    window.initDualSliders = (dotnetHelper, minGapPrix, minGapKm) => {
        const prixSliderMin = document.getElementById("prix-slider-min");
        const prixSliderMax = document.getElementById("prix-slider-max");
        const kmSliderMin = document.getElementById("km-slider-min");
        const kmSliderMax = document.getElementById("km-slider-max");

        const prixMinDisplay = document.getElementById("prix-min-display");
        const prixMaxDisplay = document.getElementById("prix-max-display");
        const kmMinDisplay = document.getElementById("km-min-display");
        const kmMaxDisplay = document.getElementById("km-max-display");

        const prixRange = document.getElementById("prix-range");
        const kmRange = document.getElementById("km-range");

        function formatPrice(value) {
            if (value >= 200000) {
                return 'Illimit√©';
            }
            return new Intl.NumberFormat('fr-FR').format(value) + ' ‚Ç¨';
        }

        function formatKm(value) {
            if (value >= 300000) {
                return 'Illimit√©';
            }
            return new Intl.NumberFormat('fr-FR').format(value) + ' km';
        }

        function updatePrixRange() {
            const min = parseInt(prixSliderMin.value);
            const max = parseInt(prixSliderMax.value);
            const percent1 = (min / 200000) * 100;
            const percent2 = (max / 200000) * 100;
            prixRange.style.left = percent1 + '%';
            prixRange.style.right = (100 - percent2) + '%';
        }

        function updateKmRange() {
            const min = parseInt(kmSliderMin.value);
            const max = parseInt(kmSliderMax.value);
            const percent1 = (min / 300000) * 100;
            const percent2 = (max / 300000) * 100;
            kmRange.style.left = percent1 + '%';
            kmRange.style.right = (100 - percent2) + '%';
        }

        // Prix Slider Min
        prixSliderMin.addEventListener('input', function () {
            let minVal = parseInt(this.value);
            let maxVal = parseInt(prixSliderMax.value);

            if (maxVal - minVal < minGapPrix) {
                this.value = maxVal - minGapPrix;
                minVal = maxVal - minGapPrix;
            }

            prixMinDisplay.textContent = formatPrice(minVal);
            updatePrixRange();
            dotnetHelper.invokeMethodAsync('UpdatePrixMin', minVal);
        });

        // Prix Slider Max
        prixSliderMax.addEventListener('input', function () {
            let minVal = parseInt(prixSliderMin.value);
            let maxVal = parseInt(this.value);

            if (maxVal - minVal < minGapPrix) {
                this.value = minVal + minGapPrix;
                maxVal = minVal + minGapPrix;
            }

            prixMaxDisplay.textContent = formatPrice(maxVal);
            updatePrixRange();
            dotnetHelper.invokeMethodAsync('UpdatePrixMax', maxVal);
        });

        // Km Slider Min
        kmSliderMin.addEventListener('input', function () {
            let minVal = parseInt(this.value);
            let maxVal = parseInt(kmSliderMax.value);

            if (maxVal - minVal < minGapKm) {
                this.value = maxVal - minGapKm;
                minVal = maxVal - minGapKm;
            }

            kmMinDisplay.textContent = formatKm(minVal);
            updateKmRange();
            dotnetHelper.invokeMethodAsync('UpdateKmMin', minVal);
        });

        // Km Slider Max
        kmSliderMax.addEventListener('input', function () {
            let minVal = parseInt(kmSliderMin.value);
            let maxVal = parseInt(this.value);

            if (maxVal - minVal < minGapKm) {
                this.value = minVal + minGapKm;
                maxVal = minVal + minGapKm;
            }

            kmMaxDisplay.textContent = formatKm(maxVal);
            updateKmRange();
            dotnetHelper.invokeMethodAsync('UpdateKmMax', maxVal);
        });

        // Initialisation
        updatePrixRange();
        updateKmRange();
    };

    window.resetSliders = (prixMin, prixMax, kmMin, kmMax) => {
        const prixSliderMin = document.getElementById("prix-slider-min");
        const prixSliderMax = document.getElementById("prix-slider-max");
        const kmSliderMin = document.getElementById("km-slider-min");
        const kmSliderMax = document.getElementById("km-slider-max");

        if (prixSliderMin) prixSliderMin.value = prixMin;
        if (prixSliderMax) prixSliderMax.value = prixMax;
        if (kmSliderMin) kmSliderMin.value = kmMin;
        if (kmSliderMax) kmSliderMax.value = kmMax;

        // Trigger input events to update displays
        prixSliderMin?.dispatchEvent(new Event('input'));
        prixSliderMax?.dispatchEvent(new Event('input'));
        kmSliderMin?.dispatchEvent(new Event('input'));
        kmSliderMax?.dispatchEvent(new Event('input'));
    };
</script>