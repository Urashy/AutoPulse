@using BlazorAutoPulse.ViewModel
@inject NavigationManager Navigation

<div class="search-bar">
    <!-- Champ de recherche par nom -->
    <div class="search-input-group">
        <input type="text"
               @bind="VM.Nom"
               @bind:event="oninput"
               placeholder="üîç Rechercher par nom de v√©hicule..."
               class="search-input-main">
    </div>

    <!-- Filtres en listes d√©roulantes -->
    <div class="filters-row">
        <!-- Marque -->
        <div class="filter-group">
            <label>Marque</label>
            <select value="@VM.SelectedMarque" @onchange="VM.OnMarqueChanged">
                <option value="0">Toutes les marques</option>
                @if (VM.AllMarques != null)
                {
                    @foreach (var marque in VM.AllMarques)
                    {
                        <option value="@marque.IdMarque">@marque.LibelleMarque</option>
                    }
                }
            </select>
        </div>

        <!-- Mod√®le -->
        <div class="filter-group">
            <label>Mod√®le</label>
            <select value="@VM.SelectedModele" @onchange="e => { VM.SelectedModele = e.Value?.ToString() ?? string.Empty; }">
                <option value="">Tous les mod√®les</option>
                @if (VM.FilteredModeles != null)
                {
                    @foreach (var modele in VM.FilteredModeles)
                    {
                        <option value="@modele.IdModele">@modele.LibelleModele</option>
                    }
                }
            </select>
        </div>

        <!-- Carburant -->
        <div class="filter-group">
            <label>Carburant</label>
            <select value="@VM.SelectedCarburant" @onchange="e => { VM.SelectedCarburant = e.Value?.ToString() ?? string.Empty; }">
                <option value="0">Tous les carburants</option>
                @if (VM.AllCarburants != null)
                {
                    @foreach (var carburant in VM.AllCarburants)
                    {
                        <option value="@carburant.IdCarburant">@carburant.LibelleCarburant</option>
                    }
                }
            </select>
        </div>

        <!-- Cat√©gorie -->
        <div class="filter-group">
            <label>Cat√©gorie</label>
            <select value="@VM.SelectedCategorie" @onchange="e => { VM.SelectedCategorie = e.Value?.ToString() ?? string.Empty; }">
                <option value="0">Toutes les cat√©gories</option>
                @if (VM.AllCategories != null)
                {
                    @foreach (var categorie in VM.AllCategories)
                    {
                        <option value="@categorie.IdCategorie">@categorie.LibelleCategorie</option>
                    }
                }
            </select>
        </div>

        <!-- D√©partement -->
        <div class="filter-group">
            <label>D√©partement</label>
            <input type="text" @bind="VM.Departement" placeholder="Ex: 73">
        </div>
    </div>

    <!-- Sliders pour Prix et Kilom√©trage -->
    <div class="sliders-container">
        <!-- Dual Slider Prix -->
        <div class="slider-group">
            <label>Prix</label>
            <div class="slider-info">
                <span>@FormatPrice(VM.PrixMinValue) ‚Ç¨</span>
                <span>@FormatPrice(VM.PrixMaxValue) ‚Ç¨</span>
            </div>
            <div class="dual-range-slider">
                <div class="slider-track"></div>
                <div class="slider-range" style="@GetRangeStyle(VM.PrixMinValue, VM.PrixMaxValue, 0, 200000)"></div>
                <input type="range"
                       min="0"
                       max="200000"
                       step="1000"
                       value="@VM.PrixMinValue"
                       @oninput="OnPrixMinChanged"
                       class="range-input range-min">
                <input type="range"
                       min="0"
                       max="200000"
                       step="1000"
                       value="@VM.PrixMaxValue"
                       @oninput="OnPrixMaxChanged"
                       class="range-input range-max">
            </div>
        </div>

        <!-- Dual Slider Kilom√©trage -->
        <div class="slider-group">
            <label>Kilom√©trage</label>
            <div class="slider-info">
                <span>@FormatKm(VM.KmMinValue) km</span>
                <span>@FormatKm(VM.KmMaxValue) km</span>
            </div>
            <div class="dual-range-slider">
                <div class="slider-track"></div>
                <div class="slider-range" style="@GetRangeStyle(VM.KmMinValue, VM.KmMaxValue, 0, 300000)"></div>
                <input type="range"
                       min="0"
                       max="300000"
                       step="5000"
                       value="@VM.KmMinValue"
                       @oninput="OnKmMinChanged"
                       class="range-input range-min">
                <input type="range"
                       min="0"
                       max="300000"
                       step="5000"
                       value="@VM.KmMaxValue"
                       @oninput="OnKmMaxChanged"
                       class="range-input range-max">
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button @onclick="HandleRecherche" class="btn-primary">üîç Rechercher</button>
        <button @onclick="HandleReset" class="btn-secondary">üîÑ R√©initialiser</button>
    </div>
</div>

@if (VM.HasActiveFilters())
{
    <div class="active-filters">
        <span>Filtres actifs :</span>
        @if (VM.SelectedMarque != "0")
        {
            <span class="filter-tag">Marque: @VM.GetMarqueLibelle(VM.SelectedMarque)</span>
        }
        @if (!string.IsNullOrEmpty(VM.SelectedModele))
        {
            <span class="filter-tag">Mod√®le: @VM.GetModeleLibelle(VM.SelectedModele)</span>
        }
        @if (VM.SelectedCarburant != "0")
        {
            <span class="filter-tag">Carburant: @VM.GetCarburantLibelle(VM.SelectedCarburant)</span>
        }
        @if (VM.SelectedCategorie != "0")
        {
            <span class="filter-tag">Cat√©gorie: @VM.GetCategorieLibelle(VM.SelectedCategorie)</span>
        }
        @if (VM.PrixMinValue > 0 || VM.PrixMaxValue < 200000)
        {
            <span class="filter-tag">Prix: @FormatPrice(VM.PrixMinValue) - @FormatPrice(VM.PrixMaxValue) ‚Ç¨</span>
        }
        @if (VM.KmMinValue > 0 || VM.KmMaxValue < 300000)
        {
            <span class="filter-tag">Km: @FormatKm(VM.KmMinValue) - @FormatKm(VM.KmMaxValue)</span>
        }
        @if (!string.IsNullOrEmpty(VM.Nom))
        {
            <span class="filter-tag">Nom: @VM.Nom</span>
        }
        @if (!string.IsNullOrEmpty(VM.Departement))
        {
            <span class="filter-tag">D√©partement: @VM.Departement</span>
        }
    </div>
}

@code {
    [Parameter]
    public required RechercheViewModel VM { get; set; }

    [Parameter]
    public bool IsHomePage { get; set; } = false;

    private const int MinGapPrix = 5000;
    private const int MinGapKm = 10000;

    private async Task OnPrixMinChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            VM.PrixMinValue = Math.Min(value, VM.PrixMaxValue - MinGapPrix);
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnPrixMaxChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            VM.PrixMaxValue = Math.Max(value, VM.PrixMinValue + MinGapPrix);
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnKmMinChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            VM.KmMinValue = Math.Min(value, VM.KmMaxValue - MinGapKm);
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnKmMaxChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            VM.KmMaxValue = Math.Max(value, VM.KmMinValue + MinGapKm);
        }
        await InvokeAsync(StateHasChanged);
    }

    private string GetRangeStyle(int minValue, int maxValue, int rangeMin, int rangeMax)
    {
        double range = rangeMax - rangeMin;
        double left = ((minValue - rangeMin) / range) * 100;
        double right = 100 - ((maxValue - rangeMin) / range) * 100;
        return $"left: {left.ToString(System.Globalization.CultureInfo.InvariantCulture)}%; right: {right.ToString(System.Globalization.CultureInfo.InvariantCulture)}%;";
    }

    private async Task HandleRecherche()
    {
        if (IsHomePage)
        {
            var queryString = VM.BuildQueryString();
            Navigation.NavigateTo($"/search{queryString}");
        }
        else
        {
            await VM.EffectuerRecherche();
        }
    }

    private async Task HandleReset()
    {
        VM.ReinitialiserFiltres();
        if (!IsHomePage)
        {
            await VM.EffectuerRecherche();
        }
    }

    private string FormatPrice(int price)
    {
        return price.ToString("N0", System.Globalization.CultureInfo.GetCultureInfo("fr-FR"));
    }

    private string FormatKm(int km)
    {
        return km.ToString("N0", System.Globalization.CultureInfo.GetCultureInfo("fr-FR"));
    }
}