@using BlazorAutoPulse.ViewModel
@inject NavigationManager Navigation

<div class="search-bar">
    <!-- Champ de recherche par nom -->
    <div class="search-input-group">
        <input type="text"
               @bind="VM.Nom"
               @bind:event="oninput"
               placeholder="🔍 Rechercher par nom de véhicule..."
               class="search-input-main">
    </div>

    <!-- Filtres en listes déroulantes -->
    <div class="filters-row">
        <!-- Marque -->
        <div class="filter-group">
            <label>Marque</label>
            <select value="@VM.SelectedMarque" @onchange="VM.OnMarqueChanged">
                <option value="0">Toutes les marques</option>
                @if (VM.AllMarques != null)
                {
                    @foreach (var marque in VM.AllMarques)
                    {
                        <option value="@marque.IdMarque">@marque.LibelleMarque</option>
                    }
                }
            </select>
        </div>

        <!-- Modèle -->
        <div class="filter-group">
            <label>Modèle</label>
            <select value="@VM.SelectedModele" @onchange="e => { VM.SelectedModele = e.Value?.ToString() ?? string.Empty; }">
                <option value="">Tous les modèles</option>
                @if (VM.FilteredModeles != null)
                {
                    @foreach (var modele in VM.FilteredModeles)
                    {
                        <option value="@modele.IdModele">@modele.LibelleModele</option>
                    }
                }
            </select>
        </div>

        <!-- Carburant -->
        <div class="filter-group">
            <label>Carburant</label>
            <select value="@VM.SelectedCarburant" @onchange="e => { VM.SelectedCarburant = e.Value?.ToString() ?? string.Empty; }">
                <option value="0">Tous les carburants</option>
                @if (VM.AllCarburants != null)
                {
                    @foreach (var carburant in VM.AllCarburants)
                    {
                        <option value="@carburant.IdCarburant">@carburant.LibelleCarburant</option>
                    }
                }
            </select>
        </div>

        <!-- Catégorie -->
        <div class="filter-group">
            <label>Catégorie</label>
            <select value="@VM.SelectedCategorie" @onchange="e => { VM.SelectedCategorie = e.Value?.ToString() ?? string.Empty; }">
                <option value="0">Toutes les catégories</option>
                @if (VM.AllCategories != null)
                {
                    @foreach (var categorie in VM.AllCategories)
                    {
                        <option value="@categorie.IdCategorie">@categorie.LibelleCategorie</option>
                    }
                }
            </select>
        </div>

        <!-- Département -->
        <div class="filter-group">
            <label>Département</label>
            <input type="text" @bind="VM.Departement" placeholder="Ex: 73">
        </div>
    </div>

    <!-- Sliders pour Prix et Kilométrage -->
    <div class="sliders-container">
        <!-- Slider Prix -->
        <div class="slider-group">
            <label>Prix</label>
            <div class="slider-info">
                <span>@FormatPrice(VM.PrixMinValue) €</span>
                <span>@FormatPrice(VM.PrixMaxValue) €</span>
            </div>
            <div class="dual-slider">
                <input type="range"
                       min="0"
                       max="200000"
                       step="1000"
                       @bind="VM.PrixMinValue"
                       @bind:event="oninput"
                       class="slider slider-min">
                <input type="range"
                       min="0"
                       max="200000"
                       step="1000"
                       @bind="VM.PrixMaxValue"
                       @bind:event="oninput"
                       class="slider slider-max">
            </div>
        </div>

        <!-- Slider Kilométrage -->
        <div class="slider-group">
            <label>Kilométrage</label>
            <div class="slider-info">
                <span>@FormatKm(VM.KmMinValue) km</span>
                <span>@FormatKm(VM.KmMaxValue) km</span>
            </div>
            <div class="dual-slider">
                <input type="range"
                       min="0"
                       max="300000"
                       step="5000"
                       @bind="VM.KmMinValue"
                       @bind:event="oninput"
                       class="slider slider-min">
                <input type="range"
                       min="0"
                       max="300000"
                       step="5000"
                       @bind="VM.KmMaxValue"
                       @bind:event="oninput"
                       class="slider slider-max">
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button @onclick="HandleRecherche" class="btn-primary">🔍 Rechercher</button>
        <button @onclick="HandleReset" class="btn-secondary">🔄 Réinitialiser</button>
    </div>
</div>

@if (VM.HasActiveFilters())
{
    <div class="active-filters">
        <span>Filtres actifs :</span>
        @if (VM.SelectedMarque != "0")
        {
            <span class="filter-tag">Marque: @VM.GetMarqueLibelle(VM.SelectedMarque)</span>
        }
        @if (!string.IsNullOrEmpty(VM.SelectedModele))
        {
            <span class="filter-tag">Modèle: @VM.GetModeleLibelle(VM.SelectedModele)</span>
        }
        @if (VM.SelectedCarburant != "0")
        {
            <span class="filter-tag">Carburant: @VM.GetCarburantLibelle(VM.SelectedCarburant)</span>
        }
        @if (VM.SelectedCategorie != "0")
        {
            <span class="filter-tag">Catégorie: @VM.GetCategorieLibelle(VM.SelectedCategorie)</span>
        }
        @if (VM.PrixMinValue > 0 || VM.PrixMaxValue < 200000)
        {
            <span class="filter-tag">Prix: @FormatPrice(VM.PrixMinValue) - @FormatPrice(VM.PrixMaxValue) €</span>
        }
        @if (VM.KmMinValue > 0 || VM.KmMaxValue < 300000)
        {
            <span class="filter-tag">Km: @FormatKm(VM.KmMinValue) - @FormatKm(VM.KmMaxValue)</span>
        }
        @if (!string.IsNullOrEmpty(VM.Nom))
        {
            <span class="filter-tag">Nom: @VM.Nom</span>
        }
        @if (!string.IsNullOrEmpty(VM.Departement))
        {
            <span class="filter-tag">Département: @VM.Departement</span>
        }
    </div>
}

@code {
    [Parameter]
    public required RechercheViewModel VM { get; set; }

    [Parameter]
    public bool IsHomePage { get; set; } = false;

    private async Task HandleRecherche()
    {
        if (IsHomePage)
        {
            var queryString = VM.BuildQueryString();
            Navigation.NavigateTo($"/search{queryString}");
        }
        else
        {
            await VM.EffectuerRecherche();
        }
    }

    private async Task HandleReset()
    {
        VM.ReinitialiserFiltres();
        if (!IsHomePage)
        {
            await VM.EffectuerRecherche();
        }
    }

    private string FormatPrice(int price)
    {
        return price.ToString("N0", System.Globalization.CultureInfo.GetCultureInfo("fr-FR"));
    }

    private string FormatKm(int km)
    {
        return km.ToString("N0", System.Globalization.CultureInfo.GetCultureInfo("fr-FR"));
    }
}