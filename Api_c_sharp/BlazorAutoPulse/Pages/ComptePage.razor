@page "/compte"
@using BlazorAutoPulse.ViewModel
@inject NavigationManager Navigation
@inject CompteViewModel VM
@inject ConnexionViewModel ConnexionVM

<PageTitle>Mon Compte - AutoPulse</PageTitle>

<!-- Modal changement de mot de passe -->
@if (VM.showPasswordModal)
{
    <div class="modal-overlay" @onclick="VM.ClosePasswordModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Changer le mot de passe</h3>
                <button class="modal-close" @onclick="VM.ClosePasswordModal">âœ•</button>
            </div>

            <div class="modal-body">
                @if (!string.IsNullOrEmpty(VM.passwordError))
                {
                    <div class="error-message-box">
                        @VM.passwordError
                    </div>
                }

                @if (!string.IsNullOrEmpty(VM.passwordSuccess))
                {
                    <div class="success-message-box">
                        âœ“ @VM.passwordSuccess
                    </div>
                }

                <form>
                    <div class="form-group @(!VM.currentPasswordValid ? "has-error" : "")">
                        <label>Mot de passe actuel</label>
                        <input type="password"
                               placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                               @bind="VM.currentPassword"
                               disabled="@VM.isChangingPassword"
                               required>
                    </div>

                    <div class="form-group @(!VM.newPasswordValid ? "has-error" : "")">
                        <label>Nouveau mot de passe</label>
                        <input type="password"
                               placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                               @bind="VM.newPassword"
                               disabled="@VM.isChangingPassword"
                               required>
                    </div>

                    <div class="form-group @(!VM.newPasswordValid ? "has-error" : "")">
                        <label>Confirmer le nouveau mot de passe</label>
                        <input type="password"
                               placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                               @bind="VM.confirmNewPassword"
                               disabled="@VM.isChangingPassword"
                               required>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" @onclick="VM.ClosePasswordModal" disabled="@VM.isChangingPassword">
                    Annuler
                </button>
                <button class="btn-primary" @onclick="VM.ChangePassword" disabled="@VM.isChangingPassword">
                    @if (VM.isChangingPassword)
                    {
                        <span>Modification...</span>
                    }
                    else
                    {
                        <span>Valider</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

<div class="compte-container">
    <!-- Section haute - Profil et informations -->
    <div class="profile-header">
        <div class="profile-left">
            <div class="profile-photo-wrapper">
                <img src="@VM.imageSource" alt="Photo de Profil" class="profile-photo" />

                <label for="photoProfil" class="photo-upload-overlay">
                    <div class="upload-icon">ðŸ“¸</div>
                    <p class="upload-text">Cliquez pour @(VM.idImage==0 ? "ajouter" : "modifier")</p>
                    <p class="upload-hint">JPG, PNG</p>
                </label>
                <InputFile id="photoProfil" OnChange="@VM.UpdateProfileImage" style="display:none"/>
            </div>
        </div>

        <div class="profile-info">
            @if (!VM.isEditing)
            {
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Nom</span>
                        <span class="info-value">@VM.compte.Nom</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">PrÃ©nom</span>
                        <span class="info-value">@VM.compte.Prenom</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Date de naissance</span>
                        <span class="info-value">@VM.compte.DateNaissance.ToString("dd/MM/yyyy")</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Pseudo</span>
                        <span class="info-value">@VM.compte.Pseudo</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Email</span>
                        <span class="info-value">@VM.compte.Email</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Biographie</span>
                        <span class="info-value">@VM.compte.Biographie</span>
                    </div>
                </div>
            }
            else
            {
                <div class="info-grid">
                    <div class="info-item">
                        <label class="info-label">Nom</label>
                        <input type="text" @bind="VM.compteEdit.Nom" class="info-input" />
                    </div>
                    <div class="info-item">
                        <label class="info-label">PrÃ©nom</label>
                        <input type="text" @bind="VM.compteEdit.Prenom" class="info-input" />
                    </div>
                    <div class="info-item">
                        <span class="info-label">Date de naissance</span>
                        <span class="info-value">@VM.compte.DateNaissance.ToString("dd/MM/yyyy")</span>
                    </div>
                    <div class="info-item">
                        <label class="info-label">Pseudo</label>
                        <input type="text" @bind="VM.compteEdit.Pseudo" class="info-input" />
                    </div>
                    <div class="info-item">
                        <label class="info-label">Email</label>
                        <input type="email" @bind="VM.compteEdit.Email" class="info-input" />
                    </div>
                    <div class="info-item">
                        <label class="info-label">Biographie</label>
                        <input type="email" @bind="VM.compteEdit.Biographie" class="info-input" />
                    </div>
                </div>
            }

            <div class="profile-actions">
                @if (!VM.isEditing)
                {
                    <button class="btn-primary" @onclick="VM.ToggleEdit">Modifier le profil</button>
                    <button class="btn-password" @onclick="VM.OpenPasswordModal">ðŸ”’ Changer le mot de passe</button>
                }
                else
                {
                    <button class="btn-primary" @onclick="VM.SaveProfile">Enregistrer</button>
                    <button class="btn-secondary" @onclick="VM.CancelEdit">Annuler</button>
                }

                <button class="btn-danger" @onclick="ConnexionVM.DeconnexionUtilisateur">DÃ©connexion</button>
            </div>
        </div>
    </div>

    <!-- Section basse - Navigation et contenu -->
    <div class="account-content">
        <nav class="account-navbar">
            <button class="nav-item @(VM.activeSection == "annonces" ? "active" : "")"
                    @onclick="@(() => VM.SetActiveSection("annonces"))">
                Annonces
            </button>
            <button class="nav-item @(VM.activeSection == "avis" ? "active" : "")"
                    @onclick="@(() => VM.SetActiveSection("avis"))">
                Avis
            </button>
            <button class="nav-item @(VM.activeSection == "adresses" ? "active" : "")"
                    @onclick="@(() => VM.SetActiveSection("adresses"))">
                Adresses
            </button>
            <button class="nav-item @(VM.activeSection == "favoris" ? "active" : "")"
                    @onclick="@(() => VM.SetActiveSection("favoris"))">
                Favoris
            </button>
            <button class="nav-item @(VM.activeSection == "commandes" ? "active" : "")"
                    @onclick="@(() => VM.SetActiveSection("commandes"))">
                Commandes
            </button>
        </nav>

        <div class="content-section">
            <!-- Ici seront injectÃ©s les diffÃ©rents composants selon la section active -->
            <div class="section-placeholder">
                <h3>Section: @VM.activeSection</h3>
                <p>Le contenu du composant @VM.activeSection sera affichÃ© ici.</p>
            </div>
        </div>
    </div>
</div>

@code {

    protected override async Task OnInitializedAsync()
    {
        ConnexionVM.SetNavigation(Navigation);
        await VM.InitializeAsync(StateHasChanged, Navigation);
    }
}