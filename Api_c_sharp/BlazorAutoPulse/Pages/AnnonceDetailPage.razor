@page "/annonce/{IdAnnonce:int}"
@using BlazorAutoPulse.ViewModel
@inject AnnonceDetailViewModel VM
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>@(VM.Annonce?.Libelle ?? "D√©tail de l'annonce") - AutoPulse</PageTitle>

@if (VM.IsLoading)
{
    <div class="loading-container">
        <div class="loader"></div>
        <p>Chargement des d√©tails...</p>
    </div>
}
else if (VM.Annonce == null)
{
    <div class="error-container">
        <h2>Annonce introuvable</h2>
        <p>L'annonce que vous recherchez n'existe pas ou a √©t√© supprim√©e.</p>
        <button @onclick="() => Navigation.NavigateTo('/'.ToString())" class="btn-back">Retour √† l'accueil</button>
    </div>
}
else
{
    <div class="detail-container">
        <!-- En-t√™te avec retour -->
        <div class="header-nav">
            <button @onclick="() => Navigation.NavigateTo('/'.ToString())" class="btn-back">‚Üê Retour</button>
            <button @onclick="VM.ToggleViewer3D" class="btn-3d">
                @(VM.show3DViewer ? "üñºÔ∏è Voir les photos" : "üé® Visualiseur 3D")
            </button>
        </div>

        <!-- Visualiseur 3D (optionnel) -->
        @if (VM.show3DViewer)
        {
            <div class="viewer-3d-section">
                <div class="color-selector">
                    <h3>Couleur de carrosserie</h3>
                    <div class="color-options">
                        @foreach (var color in VM.couleurDisponible)
                        {
                            <div class="color-option @(VM.selectedColor == color.CodeHexaCouleur ? "selected" : "")"
                                 style="background-color: @color.CodeHexaCouleur"
                                 @onclick="() => VM.ChangeCouleur(color.CodeHexaCouleur)"
                                 title="@color.LibelleCouleur">
                            </div>
                        }
                    </div>
                </div>

                <div class="viewer-3d-container">
                    <div id="car3DViewer" class="viewer-3d"></div>
                    @if (VM.isLoading3D)
                    {
                        <div class="viewer-3d-loading">
                            <div class="loader"></div>
                            <p>Chargement du mod√®le 3D...</p>
                        </div>
                    }
                </div>
            </div>
        }
        else
        {
            <!-- Section images (code existant) -->
            <div class="images-section">
                <div class="main-image">
                    @if (VM.CurrentImageIndex >= 0 && VM.ImageIds.Any())
                    {
                        <img src="@VM.GetCurrentImage()" alt="@VM.Annonce.Libelle" />
                    }
                    else
                    {
                        <div class="no-image">Aucune image disponible</div>
                    }
                </div>

                @if (VM.ImageIds.Count > 1)
                {
                    <div class="image-navigation">
                        <button @onclick="VM.PreviousImage" class="nav-btn" disabled="@(!VM.CanGoPrevious)">
                            ‚óÄ
                        </button>
                        <div class="image-counter">
                            @(VM.CurrentImageIndex + 1) / @VM.ImageIds.Count
                        </div>
                        <button @onclick="VM.NextImage" class="nav-btn" disabled="@(!VM.CanGoNext)">
                            ‚ñ∂
                        </button>
                    </div>

                    <div class="thumbnails">
                        @for (int i = 0; i < VM.ImageIds.Count; i++)
                        {
                            var index = i;
                            <div class="thumbnail @(index == VM.CurrentImageIndex ? "active" : "")"
                                 @onclick="() => VM.SelectImage(index)">
                                <img src="@VM.GetImageUrl(VM.ImageIds[index])" alt="Miniature @(index + 1)" />
                            </div>
                        }
                    </div>
                }
            </div>
        }

        <!-- Reste du code existant (informations principales, caract√©ristiques, etc.) -->
        <div class="main-info-section">
            <div class="price-section">
                <h1>@VM.Annonce.Libelle</h1>
                <div class="price">@VM.Annonce.Prix.ToString("N0") ‚Ç¨</div>
            </div>

            <div class="key-specs">
                <div class="spec-item">
                    <span class="spec-label">üìÖ Ann√©e</span>
                    <span class="spec-value">@VM.Annonce.Annee</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">üìä Kilom√©trage</span>
                    <span class="spec-value">@VM.Annonce.Kilometrage.ToString() km</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">‚õΩ Carburant</span>
                    <span class="spec-value">@VM.Annonce.Carburant</span>
                </div>
                <div class="spec-item">
                    <span class="spec-label">üìç Localisation</span>
                    <span class="spec-value">@VM.Annonce.Ville (@VM.Annonce.CodePostal)</span>
                </div>
            </div>

            <!-- Vendeur -->
            <div class="seller-section">
                <h3>Vendeur</h3>
                <div class="seller-info">
                    <div class="seller-details">
                        <p class="seller-name">@VM.Annonce.PseudoVendeur</p>
                        <p class="seller-type">@VM.Annonce.TypeCompteVendeur</p>
                    </div>
                    <button class="btn-contact">Contacter le vendeur</button>
                </div>
            </div>
        </div>

        <!-- Caract√©ristiques d√©taill√©es -->
        <div class="details-section">
            <h2>Caract√©ristiques d√©taill√©es</h2>
            <div class="specs-grid">
                <div class="spec-group">
                    <h3>G√©n√©ral</h3>
                    <div class="spec-row">
                        <span>Marque</span>
                        <span>@VM.Annonce.Marque</span>
                    </div>
                    <div class="spec-row">
                        <span>Mod√®le</span>
                        <span>@VM.Annonce.Modele</span>
                    </div>
                    <div class="spec-row">
                        <span>Ann√©e</span>
                        <span>@VM.Annonce.Annee</span>
                    </div>
                    <div class="spec-row">
                        <span>Couleur</span>
                        <span>@VM.Annonce.Couleur</span>
                    </div>
                    <div class="spec-row">
                        <span>Cat√©gorie</span>
                        <span>@VM.Annonce.Categorie</span>
                    </div>
                </div>

                <div class="spec-group">
                    <h3>Motorisation</h3>
                    <div class="spec-row">
                        <span>Puissance</span>
                        <span>@VM.Annonce.Puissance ch</span>
                    </div>
                    <div class="spec-row">
                        <span>Couple</span>
                        <span>@VM.Annonce.Couple Nm</span>
                    </div>
                    <div class="spec-row">
                        <span>Cylindres</span>
                        <span>@VM.Annonce.NbCylindres</span>
                    </div>
                    <div class="spec-row">
                        <span>Bo√Æte de vitesse</span>
                        <span>@VM.Annonce.BoiteDeVitesse</span>
                    </div>
                    <div class="spec-row">
                        <span>Motricit√©</span>
                        <span>@VM.Annonce.Motricite</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="actions-section">
            @if (VM.CurrentUserId.HasValue)
            {
                <button class="btn-favorite @(VM.IsFavorite ? "active" : "")" @onclick="VM.ToggleFavorite">
                    @(VM.IsFavorite ? "‚ù§Ô∏è Retirer des favoris" : "ü§ç Ajouter aux favoris")
                </button>
            }
            else
            {
                <button class="btn-favorite" @onclick='() => Navigation.NavigateTo("/connexion")'>
                    ü§ç Connectez-vous pour ajouter aux favoris
                </button>
            }
            <button class="btn-share">üîó Partager</button>
        </div>
    </div>
}

@code {
    [Parameter]
    public int IdAnnonce { get; set; }

    protected override async Task OnInitializedAsync()
    {
        VM.Reset();
        await VM.InitializeAsync(IdAnnonce, StateHasChanged, JSRuntime);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await Task.CompletedTask;
    }

    public async ValueTask DisposeAsync()
    {
        VM.DisposeAsync();
    }

}