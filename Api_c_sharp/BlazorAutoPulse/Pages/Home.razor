@page "/"
@using BlazorAutoPulse.ViewModel
@inject HomeViewModel VM
@inject NavigationManager Navigation

<PageTitle>AutoPulse</PageTitle>

<section class="hero no-bootstrap">
    <div class="hero-content">
        <h1>Trouvez Votre Voiture Idéale</h1>
        <p>Plus de 500 véhicules d'occasion sélectionnés et garantis</p>

        <div class="search-bar">
            <select value="@VM.SearchParams.IdMarque" @onchange="OnMarqueChanged">
                <option value="0">Marque</option>
                @if (VM.allMarques != null)
                {
                    @foreach (var marque in VM.allMarques)
                    {
                        <option value="@marque.IdMarque">@marque.LibelleMarque</option>
                    }
                }
            </select>
            <select value="@VM.SearchParams.IdModele" @onchange="OnModeleChanged">
                <option value="0">Modèle</option>
                @if (VM.filteredModeles != null)
                {
                    @foreach (var modele in VM.filteredModeles)
                    {
                        <option value="@modele.IdModele">@modele.LibelleModele</option>
                    }
                }
            </select>
            <input type="number" value="@VM.SearchParams.PrixMax" @oninput="OnPrixMaxChanged" placeholder="Prix max">
            <button @onclick="RechercherVoitures">Rechercher</button>
        </div>
    </div>
</section>

<div>
    <h2>Résultats</h2>
    @if (VM.filteredAnnonces != null && VM.filteredAnnonces.Any())
    {
        <div class="container">
            <div class="cars-grid">
                @foreach (var a in VM.filteredAnnonces)
                {
                    <AnnonceComposant Annonce="@a" />
                }
            </div>
        </div>
    }
    else
    {
        <p>Aucun résultat de recherche pour le moment.</p>
    }
</div>

<div class="container">
    <h2 class="section-title">Nos Dernières Offres</h2>
    @if (VM.allAnnonces is null)
    {
        <h2>Pas d'annonces mise en avant</h2>
    }
    else
    {
        <div class="container">
            <div class="cars-grid">
                @foreach (var a in VM.allAnnonces)
                {
                    <AnnonceComposant Annonce="@a" />
                }
            </div>
        </div>
    }
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        await VM.InitializeAsync(StateHasChanged);
    }

    private async Task OnMarqueChanged(ChangeEventArgs e)
    {
        await VM.FiltreModeleParMarque(e);
    }

    private void OnModeleChanged(ChangeEventArgs e)
    {
        VM.SearchParams.IdModele = int.Parse(e.Value?.ToString() ?? "0");
    }

    private void OnPrixMaxChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var prix))
        {
            VM.SearchParams.PrixMax = prix;
        }
        else
        {
            VM.SearchParams.PrixMax = 0;
        }
    }

    private void RechercherVoitures()
    {
        var queryParams = new List<string>();

        if (VM.SearchParams.IdMarque != 0)
            queryParams.Add($"marque={VM.SearchParams.IdMarque}");

        if (VM.SearchParams.IdModele != 0)
            queryParams.Add($"modele={VM.SearchParams.IdModele}");

        if (VM.SearchParams.PrixMax > 0)
            queryParams.Add($"prix={VM.SearchParams.PrixMax}");

        var queryString = queryParams.Count > 0 ? "?" + string.Join("&", queryParams) : "";
        Navigation.NavigateTo($"/search{queryString}");
    }
}