@page "/conversations"
@using BlazorAutoPulse.ViewModel
@inject ConversationViewModel VM
@implements IDisposable

<PageTitle>Mes Conversations - AutoPulse</PageTitle>

<div class="conversations-container">
    <div class="conversations-sidebar">
        <h2>ðŸ’¬ Conversations</h2>

        @if (VM.IsLoading)
        {
            <div class="loading">Chargement...</div>
        }
        else if (!VM.Conversations.Any())
        {
            <div class="empty-state">
                <p>Aucune conversation</p>
            </div>
        }
        else
        {
            @foreach (var conv in VM.Conversations)
            {
                <div class="conversation-item @(VM.SelectedConversation?.IdConversation == conv.IdConversation ? "active" : "")"
                     @onclick="() => VM.SelectConversation(conv)">
                    <div class="conversation-avatar">
                        @if (VM.ImageSources.ContainsKey(conv.IdParticipant) &&
                             !string.IsNullOrEmpty(VM.ImageSources[conv.IdParticipant]))
                        {
                            <img src="@VM.ImageSources[conv.IdParticipant]"
                                 alt="Profile"
                                 class="avatar-img" />
                        }
                        else
                        {
                            <span>ðŸ‘¤</span>
                        }
                    </div>
                    <div class="conversation-info">
                        <h4>@conv.LibelleAnnonce</h4>
                        <p class="last-message">
                            @(string.IsNullOrEmpty(conv.DernierMessage) ? "Aucun message" :
                            conv.DernierMessage.Length > 40 ? conv.DernierMessage.Substring(0, 40) + "..." : conv.DernierMessage)
                        </p>
                    </div>
                    @if (conv.NombreNonLu > 0)
                    {
                        <span class="unread-badge">@conv.NombreNonLu</span>
                    }
                </div>
            }
        }
    </div>

    <div class="conversation-content">
        @if (VM.SelectedConversation == null)
        {
            <div class="empty-conversation">
                <h3>SÃ©lectionnez une conversation</h3>
                <p>Choisissez une conversation pour voir les messages</p>
            </div>
        }
        else
        {
            <div class="conversation-header">
                <h3>@VM.SelectedConversation.LibelleAnnonce</h3>
                <p>@VM.SelectedConversation.ParticipantPseudo</p>
            </div>

            <div class="messages-container" @ref="VM.MessagesContainer">
                @foreach (var msg in VM.Messages)
                {
                    <div class="message @(msg.IdCompte == VM.CurrentUserId ? "sent" : "received")">
                        <div class="message-bubble">
                            <p>@msg.ContenuMessage</p>
                            <div class="message-footer">
                                <span class="message-time">@msg.DateEnvoiMessage.ToLocalTime().ToString("HH:mm")</span>
                                @if (msg.IdCompte == VM.CurrentUserId)
                                {
                                    <span class="read-indicator">@(msg.EstLu ? "âœ“âœ“" : "âœ“")</span>
                                }
                            </div>
                        </div>
                    </div>
                }

                @if (VM.IsTyping)
                {
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                }
            </div>

            <div class="message-input-container">
                <input type="text"
                       placeholder="Tapez votre message..."
                       @bind="VM.NewMessage"
                       @bind:event="oninput"
                       @onkeyup="VM.HandleTyping"
                       @onkeydown="VM.HandleKeyPress"
                       class="message-input" />

                <button @onclick="VM.SendMessage"
                        class="send-btn"
                        disabled="@string.IsNullOrWhiteSpace(VM.NewMessage)">
                    âž¤
                </button>
            </div>
        }
    </div>
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        VM._refreshUI += StateHasChanged;
        await VM.InitializeAsync();
    }

    public void Dispose()
    {
        VM._refreshUI -= StateHasChanged;
        VM.Dispose();
    }
}