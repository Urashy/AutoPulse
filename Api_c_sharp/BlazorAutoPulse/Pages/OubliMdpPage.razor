@page "/oublimdp"
@using BlazorAutoPulse.ViewModel
@inject OubliMdpViewModel VM
@inject NavigationManager nav

<PageTitle>Mot de passe oubli√© - AutoPulse</PageTitle>

<div class="auth-container">
    <div class="auth-box">
        @if (!VM.envoiDemande)
        {
            <!-- √âtape 1 : Demande de r√©initialisation -->
            <h2>Mot de passe oubli√©</h2>
            <p class="subtitle">Entrez votre adresse email pour recevoir un code de r√©initialisation</p>

            @if (!string.IsNullOrEmpty(VM.messageErreur))
            {
                <div class="error-message-box">
                    @VM.messageErreur
                </div>
            }

            <form>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email"
                           placeholder="votre@email.com"
                           @bind="VM.ReinitialisationMdp.Email"
                           disabled="@VM.isLoading"
                           required>
                </div>

                <button type="button"
                        class="btn-submit"
                        @onclick="VM.EnvoyerCodeReinitialisation"
                        disabled="@VM.isLoading">
                    @if (VM.isLoading)
                    {
                        <span>Envoi en cours...</span>
                    }
                    else
                    {
                        <span>Envoyer le code</span>
                    }
                </button>
            </form>

            <div class="auth-switch">
                Vous vous souvenez de votre mot de passe ? <a href="connexion">Se connecter</a>
            </div>
        }
        else if (!VM.codeValide)
        {
            <!-- √âtape 2 : Saisie du code -->
            <h2>V√©rification du code</h2>
            <div class="info-message-box">
                <p>üìß Un code de v√©rification a √©t√© envoy√© √† :</p>
                <p class="email-highlight">@VM.ReinitialisationMdp.Email</p>
                <p class="expiry-notice">‚è±Ô∏è Ce code est valide pendant <strong>15 minutes</strong></p>
            </div>

            @if (!string.IsNullOrEmpty(VM.messageErreur))
            {
                <div class="error-message-box">
                    @VM.messageErreur
                </div>
            }

            <form>
                <div class="form-group">
                    <label>Code de v√©rification</label>
                    <input type="text"
                           placeholder="Entrez le code re√ßu par email"
                           @bind="VM.ReinitialisationMdp.Code"
                           disabled="@VM.isLoading"
                           class="code-input"
                           required>
                </div>

                <button type="button"
                        class="btn-submit"
                        @onclick="VM.ValiderCode"
                        disabled="@VM.isLoading">
                    @if (VM.isLoading)
                    {
                        <span>V√©rification...</span>
                    }
                    else
                    {
                        <span>Valider le code</span>
                    }
                </button>
            </form>

            <!-- Compteur avant renvoi -->
            <div class="resend-section">
                @if (VM.tempsRestant > 0)
                {
                    <p class="resend-timer">
                        Renvoyer un code dans <strong>@VM.tempsRestant</strong> seconde@(VM.tempsRestant > 1 ? "s" : "")
                    </p>
                }
                else
                {
                    <button type="button"
                            class="btn-resend"
                            @onclick="VM.RenvoyerCode"
                            disabled="@VM.isLoading">
                        üîÑ Renvoyer le code
                    </button>
                }
            </div>

            <div class="auth-switch">
                <a href="connexion">‚Üê Retour √† la connexion</a>
            </div>
        }
        else
        {
            <!-- √âtape 3 : Nouveau mot de passe -->
            <h2>Nouveau mot de passe</h2>
            <p class="subtitle">Choisissez un nouveau mot de passe pour votre compte</p>

            @if (!string.IsNullOrEmpty(VM.messageErreur))
            {
                <div class="error-message-box">
                    @VM.messageErreur
                </div>
            }

            @if (!string.IsNullOrEmpty(VM.messageSucces))
            {
                <div class="success-message-box">
                    @VM.messageSucces
                </div>
            }

            <form>
                <div class="form-group @(!VM.motDePasseValide ? "has-error" : "")">
                    <label>Nouveau mot de passe</label>
                    <input type="password"
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                           @bind="VM.nouveauMotDePasse"
                           disabled="@VM.isLoading"
                           required>
                </div>

                <div class="form-group @(!VM.motDePasseValide ? "has-error" : "")">
                    <label>Confirmer le mot de passe</label>
                    <input type="password"
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                           @bind="VM.confirmationMotDePasse"
                           disabled="@VM.isLoading"
                           required>
                </div>

                <button type="button"
                        class="btn-submit"
                        @onclick="VM.ChangerMotDePasse"
                        disabled="@VM.isLoading">
                    @if (VM.isLoading)
                    {
                        <span>Modification en cours...</span>
                    }
                    else
                    {
                        <span>Changer le mot de passe</span>
                    }
                </button>
            </form>

            <div class="auth-switch">
                <a href="connexion">‚Üê Retour √† la connexion</a>
            </div>
        }
    </div>
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        await VM.InitializeAsync(StateHasChanged, nav);
    }
}