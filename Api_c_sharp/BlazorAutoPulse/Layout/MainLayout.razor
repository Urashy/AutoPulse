@using BlazorAutoPulse.Service.Interface
@using BlazorAutoPulse.Service.WebService
@using BlazorAutoPulse.ViewModel
@inherits LayoutComponentBase
@inject MainLayoutViewModel VM
@inject ISignalRService SVM
@inject NavigationManager Navigation

<header>
    <nav>
        <NavLink href="/">
            <span class="logo"> AutoPulse </span>
        </NavLink>
        <ul class="nav-links">
            <NavLink href="vente">
                <span> Vendre </span>
            </NavLink>
            <NavLink href="favoris">
                <span> ❤ Favoris</span>
            </NavLink>

            <NavLink href="conversations" class="conversation-link">
                <span class="conversation-btn">
                    💬 Conversations
                    @if (unreadCount > 0)
                    {
                        <span class="notification-badge">@unreadCount</span>
                    }
                </span>
            </NavLink>

            @if (VM.IsConnected)
            {
                <li class="profile-menu" @onclick="VM.NavigateToProfile">
                    <img src="@VM.ImageSource" alt="Profil" class="profile-picture" />
                </li>
            }
            else
            {
                <NavLink href="connexion">
                    <span class="btn-login"> Connexion </span>
                </NavLink>
            }

            @if (VM.IsAdmin)
            {
                
                <NavLink href="admin">
                    <span class="btn-login"> Mode Admin </span>
                </NavLink>
            }
                
        </ul>
    </nav>
</header>

<div>
    <article class="content">
        @Body
    </article>
</div>

<footer>
    <p>&copy; 2025 AutoPulse - Tous droits réservés</p>
    <p>📍 Chambéry, France | 📞 04 XX XX XX XX | ✉️ contact@AutoPulse.fr</p>
</footer>

@code {
    private int unreadCount = 0;
    
    protected override async Task OnInitializedAsync()
    {
        await VM.InitializeAsync(StateHasChanged, Navigation);
    }
    
    private void OnNewMessage(int conversationId, int senderId, string message, DateTime timestamp)
    {
        unreadCount++;
        StateHasChanged();
    }

    private void OnNotification(string message)
    {
        Console.WriteLine($"Notification: {message}");
    }

    private async Task LoadUnreadCount()
    {
        // TODO: Appeler l'API pour obtenir le nombre de messages non lus
        // unreadCount = await MessageService.GetUnreadCount();
    }

    public async ValueTask DisposeAsync()
    {
        SVM.OnMessageReceived -= OnNewMessage;
        await SVM.StopAsync();
    }
}